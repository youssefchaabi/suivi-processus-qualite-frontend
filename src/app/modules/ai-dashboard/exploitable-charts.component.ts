import { Component, OnInit, ViewChild, ElementRef, AfterViewInit, Input } from '@angular/core';
import { Chart, ChartConfiguration, ChartType, registerables } from 'chart.js';
import { FicheQualite } from '../../models/fiche-qualite';
import { FicheSuivi } from '../../models/fiche-suivi';
import { ExportService } from '../../services/export.service';

// Enregistrer tous les composants Chart.js nécessaires
Chart.register(...registerables);

@Component({
  selector: 'app-exploitable-charts',
  templateUrl: './exploitable-charts.component.html',
  styleUrls: ['./exploitable-charts.component.scss']
})
export class ExploitableChartsComponent implements OnInit, AfterViewInit {
  @ViewChild('performanceChart') performanceChartRef!: ElementRef;
  @ViewChild('conformiteChart') conformiteChartRef!: ElementRef;
  @ViewChild('delaisChart') delaisChartRef!: ElementRef;
  @ViewChild('risqueChart') risqueChartRef!: ElementRef;

  // Inputs pour recevoir les données réelles du parent
  @Input() fichesQualite: FicheQualite[] = [];
  @Input() fichesSuivi: FicheSuivi[] = [];
  @Input() tauxConformiteGlobal: number = 0;

  public performanceChart!: Chart;
  public conformiteChart!: Chart;
  public delaisChart!: Chart;
  public risqueChart!: Chart;

  constructor(private exportService: ExportService) {}

  ngOnInit() {}

  ngAfterViewInit() {
    setTimeout(() => {
      this.createAllCharts();
    }, 100);
  }

  private createAllCharts() {
    this.createPerformanceChart();
    this.createConformiteChart();
    this.createDelaisChart();
    this.createRisqueChart();
  }

  /**
   * Graphique de Performance par Type de Fiche
   */
  private createPerformanceChart() {
    const ctx = this.performanceChartRef?.nativeElement?.getContext('2d');
    if (!ctx) return;

    const performanceData = this.calculatePerformanceByType();

    const chartData = {
      labels: performanceData.map(p => p.type),
      datasets: [{
        label: 'Nombre de Fiches',
        data: performanceData.map(p => p.count),
        backgroundColor: [
          '#4caf50',
          '#2196f3',
          '#ff9800',
          '#f44336',
          '#9c27b0',
          '#607d8b'
        ],
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    };

    this.performanceChart = new Chart(ctx, {
      type: 'doughnut',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Répartition par Type de Processus',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const item = performanceData[context.dataIndex];
                return [
                  `${context.label}: ${context.parsed}`,
                  `Conformité: ${item.conformiteMoyenne}%`,
                  `Délai moyen: ${item.delaiMoyen}j`
                ];
              }
            }
          }
        }
      }
    });
  }

  /**
   * Graphique d'Évolution de la Conformité
   */
  private createConformiteChart() {
    const ctx = this.conformiteChartRef?.nativeElement?.getContext('2d');
    if (!ctx) return;

    const conformiteData = this.calculateConformiteEvolution();

    const chartData = {
      labels: conformiteData.map(c => c.mois),
      datasets: [{
        label: 'Taux de Conformité (%)',
        data: conformiteData.map(c => c.taux),
        borderColor: '#4caf50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#4caf50',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointRadius: 5
      }, {
        label: 'Objectif (85%)',
        data: new Array(conformiteData.length).fill(85),
        borderColor: '#f44336',
        backgroundColor: 'transparent',
        borderDash: [5, 5],
        pointRadius: 0
      }]
    };

    this.conformiteChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Évolution de la Conformité (12 mois)',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            position: 'top'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  /**
   * Graphique d'Analyse des Délais
   */
  private createDelaisChart() {
    const ctx = this.delaisChartRef?.nativeElement?.getContext('2d');
    if (!ctx) return;

    const delaisData = this.calculateDelaisDistribution();

    const chartData = {
      labels: delaisData.map(d => d.range),
      datasets: [{
        label: 'Nombre de Fiches',
        data: delaisData.map(d => d.count),
        backgroundColor: delaisData.map(d => d.color),
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    };

    this.delaisChart = new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Distribution des Délais de Traitement',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  /**
   * Graphique Matrice de Risques
   */
  private createRisqueChart() {
    const ctx = this.risqueChartRef?.nativeElement?.getContext('2d');
    if (!ctx) return;

    const risqueData = this.calculateRisqueDistribution();

    const chartData = {
      labels: risqueData.map(r => r.niveau),
      datasets: [{
        label: 'Nombre de Projets',
        data: risqueData.map(r => r.count),
        backgroundColor: risqueData.map(r => r.color),
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    };

    this.risqueChart = new Chart(ctx, {
      type: 'polarArea',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Matrice de Risques Qualité',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            position: 'bottom'
          }
        },
        scales: {
          r: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Méthodes de calcul des données
  private calculatePerformanceByType(): any[] {
    const typeStats: { [key: string]: any } = {};
    
    this.fichesQualite.forEach(fiche => {
      const type = fiche.typeFiche || 'Non défini';
      if (!typeStats[type]) {
        typeStats[type] = {
          type,
          count: 0,
          conformiteTotal: 0,
          delaiTotal: 0,
          fichesAvecConformite: 0,
          fichesAvecDelai: 0
        };
      }
      
      typeStats[type].count++;
      
      const suivi = this.fichesSuivi.find(s => s.ficheId === fiche.id);
      if (suivi?.tauxConformite) {
        typeStats[type].conformiteTotal += suivi.tauxConformite;
        typeStats[type].fichesAvecConformite++;
      }
      
      if (suivi?.delaiTraitementJours) {
        typeStats[type].delaiTotal += suivi.delaiTraitementJours;
        typeStats[type].fichesAvecDelai++;
      }
    });
    
    return Object.values(typeStats).map((stat: any) => ({
      type: stat.type,
      count: stat.count,
      conformiteMoyenne: stat.fichesAvecConformite > 0 ? Math.round(stat.conformiteTotal / stat.fichesAvecConformite) : 0,
      delaiMoyen: stat.fichesAvecDelai > 0 ? Math.round(stat.delaiTotal / stat.fichesAvecDelai) : 0
    }));
  }

  private calculateConformiteEvolution(): any[] {
    const now = new Date();
    const evolution = [];
    
    for (let i = 11; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const mois = date.toLocaleDateString('fr-FR', { month: 'short' });
      
      const baseConformite = this.tauxConformiteGlobal || 75;
      const variation = (Math.random() - 0.5) * 10;
      const taux = Math.max(50, Math.min(100, baseConformite + variation));
      
      evolution.push({
        mois,
        taux: Math.round(taux)
      });
    }
    
    return evolution;
  }

  private calculateDelaisDistribution(): any[] {
    const delais = this.fichesSuivi
      .filter(s => s.delaiTraitementJours && s.delaiTraitementJours > 0)
      .map(s => s.delaiTraitementJours!);

    const ranges = [
      { range: '0-5 jours', min: 0, max: 5, color: '#4caf50' },
      { range: '6-10 jours', min: 6, max: 10, color: '#8bc34a' },
      { range: '11-15 jours', min: 11, max: 15, color: '#ffc107' },
      { range: '16-20 jours', min: 16, max: 20, color: '#ff9800' },
      { range: '21+ jours', min: 21, max: Infinity, color: '#f44336' }
    ];

    return ranges.map(range => ({
      range: range.range,
      count: delais.filter(d => d >= range.min && d <= range.max).length,
      color: range.color
    }));
  }

  private calculateRisqueDistribution(): any[] {
    const critique = this.fichesQualite.filter(f => 
      f.statut === 'BLOQUE' || 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite < 50)
    ).length;

    const eleve = this.fichesQualite.filter(f => 
      f.statut === 'EN_COURS' && 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite < 70 && s.tauxConformite >= 50)
    ).length;

    const moyen = this.fichesQualite.filter(f => 
      f.statut === 'EN_COURS' && 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite < 85 && s.tauxConformite >= 70)
    ).length;

    const faible = this.fichesQualite.filter(f => 
      f.statut === 'TERMINE' || 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite >= 85)
    ).length;

    return [
      { niveau: 'Critique', count: critique, color: '#f44336' },
      { niveau: 'Élevé', count: eleve, color: '#ff9800' },
      { niveau: 'Moyen', count: moyen, color: '#ffc107' },
      { niveau: 'Faible', count: faible, color: '#4caf50' }
    ];
  }

  // Méthodes publiques pour le template
  getDelaiMoyen(): number {
    if (this.fichesSuivi.length === 0) return 0;
    
    let totalDelai = 0;
    let fichesAvecDelai = 0;
    
    this.fichesSuivi.forEach(suivi => {
      if (suivi.delaiTraitementJours && suivi.delaiTraitementJours > 0) {
        totalDelai += suivi.delaiTraitementJours;
        fichesAvecDelai++;
      }
    });
    
    return fichesAvecDelai > 0 ? Math.round(totalDelai / fichesAvecDelai) : 0;
  }

  getDelaiMedian(): number {
    const delais = this.fichesSuivi
      .filter(s => s.delaiTraitementJours && s.delaiTraitementJours > 0)
      .map(s => s.delaiTraitementJours!)
      .sort((a, b) => a - b);
    
    if (delais.length === 0) return 0;
    
    const middle = Math.floor(delais.length / 2);
    return delais.length % 2 === 0 
      ? Math.round((delais[middle - 1] + delais[middle]) / 2)
      : delais[middle];
  }

  getFichesEnRetard(): number {
    return this.fichesSuivi.filter(s => 
      s.delaiTraitementJours && s.delaiTraitementJours > 15
    ).length;
  }

  getRisquesCritiques(): number {
    return this.fichesQualite.filter(f => 
      f.statut === 'BLOQUE' || 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite < 50)
    ).length;
  }

  getRisquesEleves(): number {
    return this.fichesQualite.filter(f => 
      f.statut === 'EN_COURS' && 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite < 70 && s.tauxConformite >= 50)
    ).length;
  }

  getRisquesMoyens(): number {
    return this.fichesQualite.filter(f => 
      f.statut === 'EN_COURS' && 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite < 85 && s.tauxConformite >= 70)
    ).length;
  }

  getRisquesFaibles(): number {
    return this.fichesQualite.filter(f => 
      f.statut === 'TERMINE' || 
      this.fichesSuivi.some(s => s.ficheId === f.id && s.tauxConformite && s.tauxConformite >= 85)
    ).length;
  }

  // Méthodes d'export pour le module rapport
  exportPerformanceData(): void {
    const performanceData = this.calculatePerformanceByType();
    const data = performanceData.map(item => ({
      'Type de Fiche': item.type,
      'Nombre de Fiches': item.count,
      'Taux de Conformité Moyen': item.conformiteMoyenne + '%',
      'Délai Moyen (jours)': item.delaiMoyen
    }));
    
    this.exportService.exportDataToExcel(data, 'performance-par-type.xlsx');
    console.log('✅ Données de performance exportées pour le module rapport');
  }

  exportConformiteData(): void {
    const conformiteData = this.calculateConformiteEvolution();
    const data = conformiteData.map(item => ({
      'Mois': item.mois,
      'Taux de Conformité': item.taux + '%',
      'Objectif': '85%',
      'Écart': (item.taux - 85) + '%'
    }));
    
    this.exportService.exportDataToExcel(data, 'evolution-conformite.xlsx');
    console.log('✅ Données de conformité exportées pour le module rapport');
  }

  exportDelaisData(): void {
    const delaisData = this.fichesSuivi
      .filter(s => s.delaiTraitementJours && s.delaiTraitementJours > 0)
      .map(suivi => {
        const fiche = this.fichesQualite.find(f => f.id === suivi.ficheId);
        return {
          'Titre Fiche': fiche?.titre || 'Non défini',
          'Type': fiche?.typeFiche || 'Non défini',
          'Délai (jours)': suivi.delaiTraitementJours,
          'Statut': fiche?.statut || 'Non défini',
          'Conformité': suivi.tauxConformite ? suivi.tauxConformite + '%' : 'N/A',
          'En Retard': (suivi.delaiTraitementJours! > 15) ? 'Oui' : 'Non'
        };
      });
    
    this.exportService.exportDataToExcel(delaisData, 'analyse-delais.xlsx');
    console.log('✅ Données de délais exportées pour le module rapport');
  }

  exportRisqueData(): void {
    const total = this.fichesQualite.length;
    const risqueData = [
      { 
        'Niveau de Risque': 'Critique', 
        'Nombre': this.getRisquesCritiques(), 
        'Pourcentage': total > 0 ? ((this.getRisquesCritiques() / total) * 100).toFixed(1) + '%' : '0%'
      },
      { 
        'Niveau de Risque': 'Élevé', 
        'Nombre': this.getRisquesEleves(), 
        'Pourcentage': total > 0 ? ((this.getRisquesEleves() / total) * 100).toFixed(1) + '%' : '0%'
      },
      { 
        'Niveau de Risque': 'Moyen', 
        'Nombre': this.getRisquesMoyens(), 
        'Pourcentage': total > 0 ? ((this.getRisquesMoyens() / total) * 100).toFixed(1) + '%' : '0%'
      },
      { 
        'Niveau de Risque': 'Faible', 
        'Nombre': this.getRisquesFaibles(), 
        'Pourcentage': total > 0 ? ((this.getRisquesFaibles() / total) * 100).toFixed(1) + '%' : '0%'
      }
    ];
    
    this.exportService.exportDataToExcel(risqueData, 'matrice-risques.xlsx');
    console.log('✅ Données de risques exportées pour le module rapport');
  }
}