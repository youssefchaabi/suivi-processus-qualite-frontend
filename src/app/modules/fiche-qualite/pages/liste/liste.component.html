<div class="fiche-qualite-container">
  <!-- Header Premium -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>assignment</mat-icon>
        Gestion des Fiches Qualité
      </h1>
      <div class="header-stats">
        <div class="stat-card">
          <mat-icon>description</mat-icon>
          <div class="stat-info">
            <span class="stat-value">{{ fiches.length }}</span>
            <span class="stat-label">Fiches</span>
          </div>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="addFiche()" *ngIf="authService.isAdmin() || authService.isChefProjet()" class="btn-create">
        <mat-icon>add_circle</mat-icon>
        Nouvelle Fiche
      </button>
      <button mat-stroked-button (click)="retourDashboard()" class="btn-back">
        <mat-icon>arrow_back</mat-icon>
        Retour Dashboard
      </button>
    </div>
  </div>

  <!-- Filtres et Toggle -->
  <div class="filters-section" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; padding: 16px; background: white; border-radius: 8px;">
    <mat-form-field appearance="outline" style="flex: 1; min-width: 250px;">
      <mat-label>Rechercher</mat-label>
      <input matInput [(ngModel)]="recherche" (ngModelChange)="appliquerFiltres()" 
             placeholder="Titre, description, responsable...">
      <mat-icon matPrefix>search</mat-icon>
      <button mat-icon-button matSuffix *ngIf="recherche" (click)="recherche=''; appliquerFiltres()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline" style="min-width: 150px;">
      <mat-label>Statut</mat-label>
      <mat-select [(ngModel)]="filtreStatut" (selectionChange)="appliquerFiltres()">
        <mat-option value="">Tous</mat-option>
        <mat-option value="EN_COURS">En cours</mat-option>
        <mat-option value="TERMINEE">Terminée</mat-option>
        <mat-option value="VALIDEE">Validée</mat-option>
        <mat-option value="REJETEE">Rejetée</mat-option>
        <mat-option value="EN_ATTENTE">En attente</mat-option>
        <mat-option value="BLOQUEE">Bloquée</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" style="min-width: 150px;">
      <mat-label>Type</mat-label>
      <mat-select [(ngModel)]="filtreType" (selectionChange)="appliquerFiltres()">
        <mat-option value="">Tous</mat-option>
        <mat-option value="AUDIT">Audit</mat-option>
        <mat-option value="CONTROLE">Contrôle</mat-option>
        <mat-option value="AMELIORATION">Amélioration</mat-option>
        <mat-option value="FORMATION">Formation</mat-option>
        <mat-option value="MAINTENANCE">Maintenance</mat-option>
        <mat-option value="AUTRE">Autre</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-stroked-button (click)="effacerFiltres()" style="height: 56px;">
      <mat-icon>clear_all</mat-icon>
      Effacer
    </button>

    <button mat-icon-button [color]="affichageCartes ? 'primary' : ''" 
            (click)="basculerAffichage()" style="height: 56px;"
            [matTooltip]="affichageCartes ? 'Passer au tableau' : 'Passer aux cartes'">
      <mat-icon>{{ affichageCartes ? 'view_list' : 'view_module' }}</mat-icon>
    </button>
  </div>

  <!-- Loading Premium -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des fiches qualité...</p>
  </div>

  <!-- Empty State Premium -->
  <div *ngIf="!loading && fiches.length === 0" class="empty-state">
    <mat-icon>assignment_late</mat-icon>
    <h3>Aucune fiche qualité</h3>
    <p>Commencez par créer votre première fiche qualité</p>
    <button mat-raised-button color="primary" (click)="addFiche()" *ngIf="authService.isAdmin() || authService.isChefProjet()">
      <mat-icon>add_circle</mat-icon>
      Créer une fiche
    </button>
  </div>

  <!-- Vue Cartes -->
  <div *ngIf="!loading && fiches.length > 0 && affichageCartes" class="cards-container">
    <div *ngIf="fichesFiltrees.length === 0" class="no-results" style="text-align: center; padding: 40px;">
      <mat-icon style="font-size: 64px; width: 64px; height: 64px; color: #999;">search_off</mat-icon>
      <h3>Aucun résultat</h3>
      <p>Essayez de modifier vos critères de recherche</p>
      <button mat-stroked-button (click)="effacerFiltres()">Effacer les filtres</button>
    </div>

    <div class="fiches-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; padding: 20px 0;">
      <mat-card *ngFor="let fiche of fichesFiltrees" class="fiche-card" style="cursor: pointer; transition: all 0.3s;">
        <mat-card-header>
          <div mat-card-avatar class="card-avatar" [style.background-color]="getTypeColor(fiche.typeFiche)" 
               style="display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 40px; height: 40px;">
            <mat-icon style="color: white;">{{ getTypeIcon(fiche.typeFiche) }}</mat-icon>
          </div>
          <mat-card-title>{{ fiche.titre }}</mat-card-title>
          <mat-card-subtitle>{{ fiche.responsable }}</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content style="min-height: 80px;">
          <p class="description" style="color: #666; margin-bottom: 12px;">{{ fiche.description }}</p>
          <div class="card-badges" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="badge badge-type" [style.background-color]="getTypeColor(fiche.typeFiche)" 
                  style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 16px; color: white; font-size: 12px;">
              <mat-icon style="font-size: 16px; width: 16px; height: 16px;">{{ getTypeIcon(fiche.typeFiche) }}</mat-icon>
              {{ fiche.typeFiche }}
            </span>
            <span class="badge badge-statut" [style.background-color]="getStatutColor(fiche.statut)"
                  style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 16px; color: white; font-size: 12px;">
              <mat-icon style="font-size: 16px; width: 16px; height: 16px;">{{ getStatutIcon(fiche.statut) }}</mat-icon>
              {{ fiche.statut }}
            </span>
          </div>
        </mat-card-content>

        <mat-card-actions style="display: flex; justify-content: flex-end; gap: 8px;">
          <button mat-icon-button color="accent" (click)="viewFiche(fiche); $event.stopPropagation()" matTooltip="Voir détails">
            <mat-icon>visibility</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="editFiche(fiche); $event.stopPropagation()" matTooltip="Modifier" *ngIf="authService.isAdmin() || authService.isChefProjet()">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteFiche(fiche, $event)" matTooltip="Supprimer" *ngIf="authService.isAdmin() || authService.isChefProjet()">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <!-- Table Premium -->
  <div *ngIf="!loading && fiches.length > 0 && !affichageCartes" class="table-container">
    <table mat-table [dataSource]="dataSource" matSort class="fiche-qualite-table">
      
      <!-- Titre -->
      <ng-container matColumnDef="titre">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <mat-icon>title</mat-icon>
          Titre
        </th>
        <td mat-cell *matCellDef="let f">
          <div class="cell-content">
            <mat-icon class="cell-icon">description</mat-icon>
            <span class="cell-text">{{ f.titre }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Type -->
      <ng-container matColumnDef="typeFiche">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <mat-icon>category</mat-icon>
          Type
        </th>
        <td mat-cell *matCellDef="let f">
          <span class="badge badge-type">
            <mat-icon>label</mat-icon>
            {{ f.typeFiche || 'Non défini' }}
          </span>
        </td>
      </ng-container>

      <!-- Statut -->
      <ng-container matColumnDef="statut">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <mat-icon>flag</mat-icon>
          Statut
        </th>
        <td mat-cell *matCellDef="let f">
          <span class="badge badge-statut" [ngClass]="getStatutClass(f.statut)">
            <mat-icon>{{ getStatutIcon(f.statut) }}</mat-icon>
            {{ f.statut || 'Non défini' }}
          </span>
        </td>
      </ng-container>

      <!-- Responsable -->
      <ng-container matColumnDef="responsable">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <mat-icon>person</mat-icon>
          Responsable
        </th>
        <td mat-cell *matCellDef="let f">
          <div class="responsable-cell">
            <mat-icon>account_circle</mat-icon>
            <span>{{ f.responsable || 'Non assigné' }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>
          <mat-icon>settings</mat-icon>
          Actions
        </th>
        <td mat-cell *matCellDef="let f">
          <div class="action-buttons">
            <button mat-icon-button class="btn-view" (click)="viewFiche(f)" matTooltip="Voir détails">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button class="btn-edit" (click)="editFiche(f)" matTooltip="Modifier" *ngIf="authService.isAdmin() || authService.isChefProjet()">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button class="btn-delete" (click)="deleteFiche(f, $event)" matTooltip="Supprimer" *ngIf="authService.isAdmin() || authService.isChefProjet()">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="colonnes; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: colonnes;" class="table-row"></tr>
    </table>

    <mat-paginator 
      [pageSizeOptions]="[5, 10, 25, 50]" 
      [pageSize]="10"
      showFirstLastButtons
      class="paginator-premium">
    </mat-paginator>
  </div>
</div>
