<div class="kpi-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>
      <mat-icon>insights</mat-icon>
      Tableau de Bord KPI - Pilote Qualité
    </h1>
    <p class="subtitle">Suivi des indicateurs de performance et métriques qualité</p>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des données KPI...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading" class="dashboard-content">
    
    <!-- Métriques principales -->
    <div class="metrics-grid">
      <mat-card *ngFor="let metric of metrics" class="metric-card" [style.border-left-color]="metric.color">
        <mat-card-content>
          <div class="metric-content">
            <div class="metric-icon" [style.background-color]="metric.color">
              <mat-icon>{{ metric.icon }}</mat-icon>
            </div>
            <div class="metric-info">
              <h3 class="metric-value">{{ metric.value }}{{ metric.title.includes('Taux') ? '%' : '' }}</h3>
              <p class="metric-title">{{ metric.title }}</p>
              <p class="metric-description">{{ metric.description }}</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Graphiques et statistiques -->
    <div class="charts-section">
      <div class="chart-row">
        <!-- Graphique par statut -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              Répartition par Statut
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="chart-placeholder">
                <div class="chart-legend">
                  <div *ngFor="let label of statutChartData.labels; let i = index" class="legend-item">
                    <div class="legend-color" [style.background-color]="statutChartData.datasets[0]?.backgroundColor[i]"></div>
                    <span>{{ label }}: {{ statutChartData.datasets[0]?.data[i] }}</span>
                  </div>
                </div>
                <div class="chart-visual">
                  <div *ngFor="let data of statutChartData.datasets[0]?.data; let i = index" 
                       class="chart-bar" 
                       [style.height]="getStatutBarHeight(data)"
                       [style.background-color]="statutChartData.datasets[0]?.backgroundColor[i]">
                    {{ data }}
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Graphique par type -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>bar_chart</mat-icon>
              Répartition par Type
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="chart-placeholder">
                <div class="chart-legend">
                  <div *ngFor="let label of typeChartData.labels; let i = index" class="legend-item">
                    <div class="legend-color" [style.background-color]="typeChartData.datasets[0]?.backgroundColor[i]"></div>
                    <span>{{ label }}: {{ typeChartData.datasets[0]?.data[i] }}</span>
                  </div>
                </div>
                <div class="chart-visual">
                  <div *ngFor="let data of typeChartData.datasets[0]?.data; let i = index" 
                       class="chart-bar" 
                       [style.height]="getTypeBarHeight(data)"
                       [style.background-color]="typeChartData.datasets[0]?.backgroundColor[i]">
                    {{ data }}
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Graphique d'évolution -->
      <mat-card class="chart-card full-width">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>trending_up</mat-icon>
            Évolution des Fiches Qualité
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <div class="chart-placeholder">
              <div class="evolution-chart">
                <div class="chart-labels">
                  <span *ngFor="let label of evolutionChartData.labels">{{ label }}</span>
                </div>
                <div class="chart-line">
                  <div *ngFor="let data of evolutionChartData.datasets[0]?.data; let i = index" 
                       class="chart-point"
                       [style.left]="getEvolutionPointLeft(i)"
                       [style.bottom]="getEvolutionPointBottom(data)">
                    {{ data }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Tableaux de données -->
    <div class="tables-section">
      <div class="table-row">
        <!-- Fiches récentes -->
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>schedule</mat-icon>
              Fiches Qualité Récentes
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <table mat-table [dataSource]="getFichesRecentes()" class="data-table">
              <ng-container matColumnDef="titre">
                <th mat-header-cell *matHeaderCellDef>Titre</th>
                <td mat-cell *matCellDef="let fiche">{{ fiche.titre }}</td>
              </ng-container>
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let fiche">{{ fiche.typeFiche }}</td>
              </ng-container>
              <ng-container matColumnDef="statut">
                <th mat-header-cell *matHeaderCellDef>Statut</th>
                <td mat-cell *matCellDef="let fiche">
                  <mat-chip [color]="fiche.statut === 'TERMINE' ? 'accent' : 'primary'" selected>
                    {{ fiche.statut }}
                  </mat-chip>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['titre', 'type', 'statut']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['titre', 'type', 'statut'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>

        <!-- Fiches en retard -->
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>warning</mat-icon>
              Fiches en Retard
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <table mat-table [dataSource]="getFichesEnRetard()" class="data-table">
              <ng-container matColumnDef="titre">
                <th mat-header-cell *matHeaderCellDef>Titre</th>
                <td mat-cell *matCellDef="let fiche">{{ fiche.titre }}</td>
              </ng-container>
              <ng-container matColumnDef="responsable">
                <th mat-header-cell *matHeaderCellDef>Responsable</th>
                <td mat-cell *matCellDef="let fiche">{{ fiche.responsable }}</td>
              </ng-container>
              <ng-container matColumnDef="priorite">
                <th mat-header-cell *matHeaderCellDef>Raison du Retard</th>
                <td mat-cell *matCellDef="let fiche">
                  <mat-chip color="warn" selected>{{ fiche.raisonRetard || 'Élevée' }}</mat-chip>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['titre', 'responsable', 'priorite']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['titre', 'responsable', 'priorite'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Résumé des actions -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>assignment</mat-icon>
          Résumé des Actions Recommandées
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="actions-list">
          <div class="action-item" *ngIf="tauxConformite < 80">
            <mat-icon color="warn">priority_high</mat-icon>
            <span>Le taux de conformité est faible ({{ tauxConformite | number:'1.0-0' }}%). Actions correctives recommandées.</span>
          </div>
          <div class="action-item" *ngIf="getFichesEnRetard().length > 0">
            <mat-icon color="warn">schedule</mat-icon>
            <span>{{ getFichesEnRetard().length }} fiches en retard nécessitent un suivi urgent.</span>
          </div>
          <div class="action-item" *ngIf="totalFichesSuivi === 0">
            <mat-icon color="accent">info</mat-icon>
            <span>Aucune fiche de suivi créée. Créer des fiches de suivi pour améliorer le suivi qualité.</span>
          </div>
          <div class="action-item" *ngIf="tauxConformite >= 80 && getFichesEnRetard().length === 0">
            <mat-icon color="primary">check_circle</mat-icon>
            <span>Excellent ! Tous les indicateurs sont dans les normes attendues.</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div> 